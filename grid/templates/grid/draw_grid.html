{% extends 'grid/base.html' %}
{% load static %}
{% load app_filters %}
{% block content %}
<div class = "col-sm-2">
    <div class="row">
        <div class= "title-input col-xs-2">#</div>
        <div class="title-input col-xs-5">Velocity</div>
        <div class="title-input col-xs-5">Concentration</div>
    </div>
    {% for key,value in data.initC.items %}
        <div class="row">
            <div class= "title-input form-group col-xs-2">{{key}}</div>
            <div class="form-group col-xs-5">
                <input type="number" class="form-control" step="0.01" min="0" value="{{data.initV|lookup:key}}" id="iv{{key}}">
            </div>
            <div class="form-group col-xs-5">
                <input type="number" class="form-control" step="0.01" min="0" value="{{value}}" id="ic{{key}}">
            </div>
        </div>
    {% endfor %}
    <div class="row btn-run">
        <button class="btn" id="run-btn">Run</button>
    </div>
    <div id="error-msg"></div>
</div>
<div class = "col-sm-8">
	<div id='graph-container'></div>     
</div>
<div class="col-sm-2">
    <table class="table result-table">
        <thread>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Output Velocity (mm/s)</th>
                <th scope="col">Output Concentration (mol/mm<sup>3</sup>)</th>
            </tr>
        </thread>        
        <tbody id="tresult">
            {% for conc,vel in data.resultList %}
            <tr>
                <th scope="row"> {{ forloop.counter }}</th>
                <td>{{ vel|floatformat:2 }}</td>
                <td>{{ conc|floatformat:2}}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script type="text/javascript" src="{% static 'js/sigma.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
<script>
    var raw = "{{data.graph}}";
    var eclickcolor = '#fbaf08';
    var edefaultcolor = '#e1e8f0';
    var g = JSON.parse(raw.replace(/(&quot\;)/g,"\""));     
    s = new sigma({
      graph: g,
      renderer: {
        container: document.getElementById('graph-container'),
        type: 'canvas'
      },
      settings: {
        doubleClickEnabled: false,
        minEdgeSize: 0.5,
        maxEdgeSize: 4,
        enableEdgeHovering: true,
        edgeHoverColor: 'default',
        defaultEdgeHoverColor: '#ffdc6a',
        edgeHoverSizeRatio: 1,
        edgeHoverExtremities: true,
        defaultEdgeColor:'#6ed3cf',
        enableCamera: false
      }
    });
    s.refresh();        
    s.bind('clickEdge doubleClickEdge', function(e) {
        if(e.data.edge.mutable){
            if(!e.data.edge.selected){
                e.data.edge.color = eclickcolor;
                e.data.edge.selected = true;
            }else{
                e.data.edge.color = edefaultcolor;
                e.data.edge.selected = false;
            }
                
        }
        // console.log(e.data.edge)
        s.refresh();                    
    });

$(document).on("click", "#run-btn",function(){
     var graph = {
        'nodes': s.graph.nodes(),
        'edges': s.graph.edges()
    }
    var nc = "{{data.nc}}";
    var ic = [];
    var iv = [];
    for(i=1;i<=nc;i++){
        var namec = "#ic" + i.toString();
        var namev = "#iv" + i.toString();
        ic.push($(namec).val());
        iv.push($(namev).val());
    }
    var sic = ic.join(",");
    var siv = iv.join(",");
    $.ajax({
        url: '/draw',
        type: 'POST',
        data: {
            status: 1,
            graph: JSON.stringify(graph),
            iv: siv,
            ic: sic
        },
        dataType: 'json',
        success: function (data) {
            // var msg = $(".side-nav-right").text();
            if (data=='0'){
                $("#error-msg").text("Grid has no input and/or output or it is not connected");
                $("#cresult").text("");
                $("#vresult").text(""); 
            }else{
                $("#error-msg").text("");
                var g = data.graph;
                s.graph = g;
                s.refresh();
                console.log(data.resultList);
                var rdiv = $('#tresult');
                rdiv.html('');
                for (i=0;i<data.resultList.length;i++){
                   rdiv.append('<tr><th scope="row">'+(i+1)+
                    '</th><td>'+data.resultList[i][1].toFixed(2)+
                    '</td><td>'+data.resultList[i][0].toFixed(2)+'</td></tr>');
                }
            }                
        }   
  });//end click button
});
</script>
{% endblock %}


