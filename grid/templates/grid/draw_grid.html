{% extends 'grid/base.html' %}
{% load static %}
{% load app_filters %}
{% block content %}
<div class = "col-sm-2">
    <div class="row">
        <div class= "title-input col-xs-2">Inlet #</div>
        <div class="title-input col-xs-5">Inlet Velocity</div>
        <div class="title-input col-xs-5">Inlet Concentration</div>
    </div>
    {% for key,value in data.initC.items %}
        <div class="row">
            <div class= "title-input form-group col-xs-2">{{key}}</div>
            <div class="form-group col-xs-5">
                <input type="number" class="form-control" step="0.01" min="0" value="{{data.initV|lookup:key}}" id="iv{{key}}">
            </div>
            <div class="form-group col-xs-5">
                <input type="number" class="form-control" step="0.01" min="0" value="{{value}}" id="ic{{key}}">
            </div>
        </div>
    {% endfor %}
    <div class="row btn-run">
        <button class="btn" id="run-btn">Run</button>
    </div>
    <div id="error-msg"></div>
</div>
<div class = "col-sm-8">
	<div id='graph-container'></div>     
</div>
<div class="col-sm-2">
    <div class="row">
        <div class= "title-input col-xs-2">Outlet #</div>
        <div class="title-input col-xs-5">Outlet Velocity</div>
        <div class="title-input col-xs-5">Outlet Concentration</div>
    </div>   
    <div class="row" id="tresult">
        <div class= "title-input form-group col-xs-2">{{forloop.counter}}</div>
        <div class="form-group col-xs-5">
            {{ vel|floatformat:2 }}
        </div>
        <div class="form-group col-xs-5">
            {{ conc|floatformat:2}}
        </div>
    </div>
</div>
<script type="text/javascript" src="{% static 'js/sigma.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
<script>
    var raw = "{{data.graph}}";
    var eclickcolor = '#fbaf08';
    var edefaultcolor = '#e1e8f0';
    var defaultcolor = '#6ed3cf';
    var ehoovercolor = '#ffdc6a';
    var g = JSON.parse(raw.replace(/(&quot\;)/g,"\""));     
    s = new sigma({
      graph: g,
      renderer: {
        container: document.getElementById('graph-container'),
        type: 'canvas'
      },
      settings: {
        doubleClickEnabled: false,
        minEdgeSize: 0.5,
        maxEdgeSize: 4,
        enableEdgeHovering: true,
        edgeHoverColor: 'default',
        defaultEdgeHoverColor: ehoovercolor,
        edgeHoverSizeRatio: 1,
        edgeHoverExtremities: true,
        defaultEdgeColor:defaultcolor,
        enableCamera: false,
        defaultLabelColor:defaultcolor,
      }
    });
    s.refresh();        
    s.bind('clickEdge doubleClickEdge', function(e) {
        if(e.data.edge.mutable){
            if(!e.data.edge.selected){
                e.data.edge.color = eclickcolor;
                e.data.edge.selected = true;
            }else{
                e.data.edge.color = edefaultcolor;
                e.data.edge.selected = false;
            }
                
        }
        // console.log(e.data.edge)
        s.refresh();                    
    });

$(document).on("click", "#run-btn",function(){
     var graph = {
        'nodes': s.graph.nodes(),
        'edges': s.graph.edges()
    }
    var nc = "{{data.nc}}";
    var ic = [];
    var iv = [];
    for(i=1;i<=nc;i++){
        var namec = "#ic" + i.toString();
        var namev = "#iv" + i.toString();
        ic.push($(namec).val());
        iv.push($(namev).val());
    }
    var sic = ic.join(",");
    var siv = iv.join(",");
    $.ajax({
        url: '/draw',
        type: 'POST',
        data: {
            status: 1,
            graph: JSON.stringify(graph),
            iv: siv,
            ic: sic
        },
        dataType: 'json',
        success: function (data) {
            // var msg = $(".side-nav-right").text();
            if (data=='0'){
                $("#error-msg").text("Grid has no input and/or output or it is not connected");
                $("#cresult").text("");
                $("#vresult").text(""); 
            }else{
                $("#error-msg").text("");
                var g = data.graph;
                s.graph = g;
                s.refresh();
                console.log(data.resultList);
                var rdiv = $('#tresult');
                rdiv.html('');
                for (i=0;i<data.resultList.length;i++){
                   rdiv.append('<div class= "title-input form-group col-xs-2">'+(i+1)+
                    '</div><div class="form-group col-xs-5">'+data.resultList[i][1].toFixed(2)+
                    ' </div><div class="form-group col-xs-5">'+data.resultList[i][0].toFixed(2)+'</div>');
                }
            }                
        }   
  });//end click button
});
</script>
{% endblock %}


