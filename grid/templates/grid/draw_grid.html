{% extends 'grid/base.html' %}
{% load static %}
{% load app_filters %}
{% block content %}
<div class="row main">
    <div class = "col-2">
        <div class="row align-items-center">
            <div class= "title-input col-2">#</div>
            <div class="title-input col-5">Inlet Velocity</div>
            <div class="title-input col-5">Inlet Concentration</div>
        </div>
        {% for key,value in data.initC.items %}
            <div class="row align-items-center">
                <div class= "title-input col-2">{{key}}</div>
                <div class="form-group col-5">
                    <input type="number" class="form-control" step="0.01" min="0" value="{{data.initV|lookup:key}}" id="iv{{key}}">
                </div>
                <div class="form-group col-5">
                    <input type="number" class="form-control" step="0.01" min="0" value="{{value}}" id="ic{{key}}">
                </div>
            </div>
        {% endfor %}

        <div class="row btn-run">
            <button class="btn" id="run-btn">Run</button>
        </div>
        <div id="error-msg"></div>
    </div>

    <div class="col-2" id="tresult">
        <div class="row align-items-center">
            <div class = "title-input col-2"></div>
            <div class="title-input col-5">Outlet Velocity</div>
            <div class="title-input col-5">Outlet Concentration</div>
        </div>
        <div class="row" id="tresult"></div>        
    </div>

    <div class = "col-8 no-float">
        <div id='graph-container'></div>     
    </div>    
</div>

<script type="text/javascript" src="{% static 'js/sigma.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
<script>
    var raw = "{{data.graph}}";
    var eclickcolor = '#fbaf08';
    var edefaultcolor = '#e1e8f0';
    var defaultcolor = '#6ed3cf';
    var ehoovercolor = '#ffdc6a';

    var g = JSON.parse(raw.replace(/(&quot\;)/g,"\""));
    s = new sigma({
      graph: g,
      renderer: {
        container: document.getElementById('graph-container'),
        type: 'canvas'
      },
      settings: {
        doubleClickEnabled: false,
        minEdgeSize: 0.5,
        maxEdgeSize: 4,
        enableEdgeHovering: true,
        edgeHoverColor: 'default',
        defaultEdgeHoverColor: ehoovercolor,
        edgeHoverSizeRatio: 1,
        edgeHoverExtremities: true,
        defaultEdgeColor:defaultcolor,
        enableCamera: false,
        defaultLabelColor:defaultcolor,
      }
    });

    s.refresh();        
    s.bind('clickEdge doubleClickEdge', function(e) {
        if(e.data.edge.mutable){
            if(!e.data.edge.selected){
                e.data.edge.color = eclickcolor;
                e.data.edge.selected = true;
                s.graph.nodes(e.data.edge.source).color = eclickcolor;
                s.graph.nodes(e.data.edge.target).color = eclickcolor;          
            }else{
                e.data.edge.color = edefaultcolor;
                e.data.edge.selected = false;
                var source = s.graph.nodes(e.data.edge.source);
                var target = s.graph.nodes(e.data.edge.target);
                var sedges = s.graph.edges().filter(edge => edge["source"]===source.id || edge["target"]===source.id);                
                var flag = false;

                for(var i=0;i<sedges.length;i++){
                    if(sedges[i].selected==true){
                        flag = true;
                        break;
                    }    
                }
                if(flag==false)
                    source.color = edefaultcolor;
                var tedges = s.graph.edges().filter(edge => edge["source"]===target.id || edge["target"]===target.id);
                flag = false;
                 for(var i=0;i<tedges.length;i++){
                    if(tedges[i].selected==true){
                        flag = true;
                        break;
                    }    
                }
                if(flag==false)
                    target.color = edefaultcolor;
            }
                
        }
        // console.log(lookupNodesByKeyValue(s,'id',e.data.edge.source)[0].color);
        s.refresh();                    
    });

$(document).on("click", "#run-btn",function(){
     var graph = {
        'nodes': s.graph.nodes(),
        'edges': s.graph.edges()
    }
    var nc = "{{data.nc}}";
    var ic = [];
    var iv = [];
    for(i=1;i<=nc;i++){
        var namec = "#ic" + i.toString();
        var namev = "#iv" + i.toString();
        ic.push($(namec).val());
        iv.push($(namev).val());
    }
    var sic = ic.join(",");
    var siv = iv.join(",");
    $.ajax({
        url: '/draw',
        type: 'POST',
        data: {
            status: 1,
            graph: JSON.stringify(graph),
            iv: siv,
            ic: sic
        },
        dataType: 'json',
        success: function (data) {
            // var msg = $(".side-nav-right").text();
            if (data=='0'){
                $("#error-msg").text("Grid has no input and/or output or it is not connected");
            }else if(data=='1'){
                $("#error-msg").text("Invalid inlet concentration. Concentration of choosen inlets must be in decreasing order");
            }else{
                $("#error-msg").text("");
                var g = JSON.parse(data.graph.replace(/(&quot\;)/g,"\""));
                for (var i=0;i<g.nodes.length;i++){
                    var id = g.nodes[i]["id"];
                    s.graph.nodes(id).color = g.nodes[i]["color"];
                }
                for (var i=0;i<g.edges.length;i++){
                    var id = g.edges[i]["id"];
                    s.graph.edges(id).color = g.edges[i]["color"];
                     s.graph.edges(id).selected = g.edges[i]["selected"];
                }
                s.refresh();
                var rdiv = $('#tresult');
                rdiv.html('');
                rdiv.append('<div class="row align-items-center"><div class = "title-input col"></div><div class="title-input col-5">Outlet Velocity</div><div class="title-input col-5">Outlet Concentration</div>');
                for (i=0;i<data.resultList.length;i++){
                    if(data.resultList[i][1]!=0){
                        rdiv.append('<div class="row align-items-center justify-content-center"><div class = "col"></div><div class="form-group col-5"><input type="number" readonly="readonly" onfocus="this.blur()" class="form-control-plaintext" value="'+data.resultList[i][1].toFixed(2)+
                        '"></div><div class="form-group col-5"><input type="number" onfocus="this.blur()" readonly class="form-control-plaintext" value="'+data.resultList[i][0].toFixed(2)+'"></div></div>');
                    }else{
                        rdiv.append('<div class="row align-items-center justify-content-center"><div class = "title-input col-2"></div><div class="form-group col-5"><input type="number" readonly="readonly" onfocus="this.blur()" class="form-control-plaintext" value=""></div><div class="form-group col-5"><input type="number" onfocus="this.blur()" readonly class="form-control-plaintext" value=""></div></div>');
                    }                  
                }
            }                
        }   
  });//end click button
});
</script>
{% endblock %}


